<!DOCTYPE html>
<html>
<head>
  <title>Roam Temporal Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
    }
    #map {
      height: 100vh;
      width: 100vw;
    }
    .controls {
      position: absolute;
      top: 10px;
      left: 10px;
      right: 10px;
      z-index: 1000;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      background: rgba(255,255,255,0.9);
      padding: 8px;
      border-radius: 8px;
    }
    .controls select,
    .controls button {
      font-size: 14px;
      padding: 5px;
      flex: 1 1 120px;
    }
  </style>
</head>
<body>
<div class="controls">
  <select id="themeDropdown">
    <option value="">Select Theme</option>
    <option value="Quiet Luxury">Quiet Luxury</option>
    <option value="Hedonist's Loop">Hedonist's Loop</option>
    <option value="Creative Recharge">Creative Recharge</option>
    <option value="Wellness Ritual">Wellness Ritual</option>
    <option value="Alt Crawl">Alt Crawl</option>
    <option value="Power Lunch">Power Lunch</option>
    <option value="Cozy Corners">Cozy Corners</option>
    <option value="Flirt & Flow">Flirt & Flow</option>
    <option value="Urban Safari">Urban Safari</option>
  </select>
  <select id="neighborhood-input">
    <option value="">Select Neighborhood</option>
    <option>Alphabet City</option>
    <option>BedStuy</option>
    <option>Bushwick</option>
    <option>Chelsea</option>
    <option>Chinatown</option>
    <option>Clinton Hill</option>
    <option>Downtown Brooklyn</option>
    <option>Dumbo</option>
    <option>East Village</option>
    <option>Gramercy</option>
    <option>Greenpoint</option>
    <option>Greenwich Village</option>
    <option>Lower East Side</option>
    <option>Long Island City</option>
    <option>Midtown</option>
    <option>SoHo</option>
    <option>Tribeca</option>
    <option>Upper East Side</option>
    <option>Upper West Side</option>
    <option>West Village</option>
    <option>Williamsburg</option>
  </select>
  <select id="priceFilter">
    <option value="">Price</option>
    <option value="$">$</option>
    <option value="$$">$$</option>
    <option value="$$$">$$$</option>
    <option value="$$$$">$$$$</option>
  </select>
  <select id="durationDropdown">
    <option value="medium">How Long?</option>
    <option value="short">Short (≤2h)</option>
    <option value="medium">Medium (2.5–5h)</option>
    <option value="long">Long (5.5–8h)</option>
  </select>
  <button id="crawlNowBtn">Crawl Now</button>
</div>
<div id="map"></div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<script>
const defaultIcon = L.icon({
  iconUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-icon.png',
  shadowUrl: 'https://unpkg.com/leaflet@1.9.3/dist/images/marker-shadow.png',
  iconSize: [25, 41],
  iconAnchor: [12, 41],
  popupAnchor: [1, -34],
  shadowSize: [41, 41]
});

  let allLocations = [];
  
const map = L.map('map').setView([40.72, -73.98], 12);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; OpenStreetMap contributors & Carto',
  subdomains: 'abcd',
  maxZoom: 19
}).addTo(map);


function generateCrawlRoute(allLocations) {
  const neighborhood = document.getElementById('neighborhood-input').value.toLowerCase();
  const priceFilter = document.getElementById('priceFilter').value.trim();
  const theme = document.getElementById('themeDropdown').value.toLowerCase();
  const durationSetting = document.getElementById('durationDropdown').value;

  const neighborhoodCenter = neighborhoodCenters[neighborhood];
  if (!neighborhoodCenter) {
    alert('Invalid neighborhood selected.');
    return;
  }
  
fetch('events.json')
  .then(res => res.json())
  .then(events => {
    events.forEach(ev => {
      const marker = L.marker([ev.lat, ev.lon], { icon: defaultIcon });
      marker.vibe = ev.vibe.toLowerCase();
      marker.name = ev.name.toLowerCase();
      marker.price = ev.price;
      marker.duration = ev.duration || 0;
      marker.options.link = ev.link;
      marker.options.hours = ev.hours || [];

      // Add marker to the map or some layer group if needed
      marker.addTo(map); // or someGroup.addLayer(marker);
    });
  })
      

    allLocations = events.map(ev => ({
      name: ev.name,
      vibe: typeof ev.vibe === 'string' ? ev.vibe.split(',').map(v => v.trim().toLowerCase()) : [],
      lat: parseFloat(ev.lat),
      lon: parseFloat(ev.lon),
      link: ev.link,
      openNow: ev.openNow,
      hours: ev.hours || [],
      hoursNumeric: ev.hoursNumeric || {},
      dayParts: Object.values(ev.dayParts || {}).filter(dp => dp !== '-' && dp !== ''),
      timeCategory: ev.timeCategory,
      energyRamp: ev.energyRamp,
      tags: ev.tags,
      price: ev.price,
      duration: ev.duration
    }));
  }

  
function getCurrentDayPart() {
  const hour = new Date().getHours();
  if (hour >= 6 && hour < 11) return ['M'];
  if (hour >= 11 && hour < 14) return ['MD'];
  if (hour >= 14 && hour < 16) return ['A'];
  if (hour >= 16 && hour < 19) return ['HH'];
  if (hour >= 19 && hour < 22) return ['E'];
  if (hour >= 22 || hour < 6) return ['L'];
  return [];
}

const currentDayParts = getCurrentDayPart();

const neighborhoodCenters = {
  "alphabet city": { lat: 40.7265, lon: -73.9815 },
  "bedstuy": { lat: 40.6850, lon: -73.9419 },
  "bushwick": { lat: 40.6943, lon: -73.9213 },
  "chelsea": { lat: 40.7465, lon: -74.0014 },
  "chinatown": { lat: 40.7158, lon: -73.9970 },
  "clinton hill": { lat: 40.6896, lon: -73.9606 },
  "downtown brooklyn": { lat: 40.6928, lon: -73.9903 },
  "dumbo": { lat: 40.7033, lon: -73.9881 },
  "east village": { lat: 40.7260, lon: -73.9816 },
  "gramercy": { lat: 40.7376, lon: -73.9857 },
  "greenpoint": { lat: 40.7301, lon: -73.9546 },
  "greenwich village": { lat: 40.7336, lon: -74.0027 },
  "lower east side": { lat: 40.7150, lon: -73.9843 },
  "long island city": { lat: 40.7440, lon: -73.9488 },
  "midtown": { lat: 40.7549, lon: -73.9840 },
  "soho": { lat: 40.7233, lon: -74.0030 },
  "tribeca": { lat: 40.7163, lon: -74.0086 },
  "upper east side": { lat: 40.7736, lon: -73.9566 },
  "upper west side": { lat: 40.7870, lon: -73.9754 },
  "west village": { lat: 40.7359, lon: -74.0036 },
  "williamsburg": { lat: 40.7081, lon: -73.9571 }
};


const themeMap = {
  "quiet luxury": ["martini", "rooftop", "lounge", "luxury", "refined", "tasting", "elegant", "cocktail", "chic"],
  "hedonist's loop": ["vinyl", "dance", "cocktail", "party", "beats", "late", "diner", "club", "after hours"],
  "creative recharge": ["cafe", "gallery", "poetry", "studio", "art", "workshop", "craft", "book", "inspire"],
  "wellness ritual": ["matcha", "bath", "yoga", "spa", "relax", "meditation", "serenity", "retreat", "garden"],
  "alt crawl": ["basement", "underground", "alt", "indie", "vinyl", "chill", "lounge", "beats", "eclectic"],
  "power lunch": ["lunch", "bistro", "brunch", "bite", "noon", "business", "daytime", "grove", "bar"],
  "cozy corners": ["cozy", "hearth", "nook", "quiet", "cafe", "book", "niche", "intimate", "cinema"],
  "flirt & flow": ["martini", "romantic", "flirt", "date", "vibe", "twilight", "jazz", "modernist", "glow"],
  "urban safari": ["explore", "rooftop", "view", "city", "street", "skyline", "vr", "wander", "overlook"]
};


  const openLocations = allLocations.filter(loc => {
    const priceTiers = ['$', '$$', '$$$', '$$$$'];
    const selectedTierIndex = priceTiers.indexOf(priceFilter);
    const matchesPrice = !priceFilter || (loc.price && priceTiers.indexOf(loc.price) <= selectedTierIndex);
    const matchesTheme = !theme || (themeMap[theme] || []).some(kw => loc.vibe?.join(' ').toLowerCase().includes(kw));
    const currentIndex = ['M', 'MD', 'A', 'HH', 'E', 'L'].findIndex(p => currentDayParts.includes(p));
    const futureParts = ['M', 'MD', 'A', 'HH', 'E', 'L'].slice(currentIndex);
    const isOpenTemporal = loc.dayParts.some(part => futureParts.includes(part));
    return matchesPrice && matchesTheme && isOpenTemporal;
  });

  function checkOpenLocations(openLocations) {
  if (openLocations.length === 0) {
    alert('No suitable locations found.');
    return;
  }
}

  const initialOptions = openLocations.filter(loc => {
    const center = L.latLng(neighborhoodCenter.lat, neighborhoodCenter.lon);
    const locLatLng = L.latLng(loc.lat, loc.lon);
    return center.distanceTo(locLatLng) <= 175;
  });

  if (initialOptions.length === 0) {
    alert('No suitable starting points within the neighborhood center.');
    return;
  }

  const crawlRoute = [initialOptions[0]];
  let totalDuration = initialOptions[0].duration || 0;
  const maxDuration = durationSetting === 'short' ? 2 : durationSetting === 'medium' ? 5 : 8;

  let lastStop = initialOptions[0];
  let lastDayPartIndex = ['M', 'MD', 'A', 'HH', 'E', 'L'].findIndex(p => lastStop.dayParts.includes(p));
  const remaining = openLocations.filter(loc => loc !== lastStop);

  for (let loc of remaining) {
    if (!loc.duration || totalDuration + loc.duration > maxDuration) continue;
    const lastLatLng = L.latLng(lastStop.lat, lastStop.lon);
    const locLatLng = L.latLng(loc.lat, loc.lon);
    if (lastLatLng.distanceTo(locLatLng) <= 350) {
      const locDayPartIndex = ['M', 'MD', 'A', 'HH', 'E', 'L'].findIndex(p => loc.dayParts.includes(p));
      if (locDayPartIndex >= lastDayPartIndex) {
        crawlRoute.push(loc);
        totalDuration += loc.duration;
        lastStop = loc;
        lastDayPartIndex = locDayPartIndex;
      }
    }
    if (totalDuration >= maxDuration) break;
  }

  if (crawlRoute.length < 2) {
    alert('A crawl requires at least 2 stops. Try adjusting your filters or duration.');
    return;
  }

  if (window.routeLayer) {
    map.removeControl(window.routeLayer);
  }

  const waypoints = crawlRoute.map(loc => L.latLng(loc.lat, loc.lon));
  window.routeLayer = L.Routing.control({
    waypoints,
    routeWhileDragging: false,
    draggableWaypoints: false,
    addWaypoints: false,
    show: false
  }).addTo(map);
}

  
    document.getElementById('crawlNowBtn').addEventListener('click', () => {
      generateCrawlRoute(allLocations);
    });

</script>
<div style="position: absolute; bottom: 3px; right: 0px; z-index: 1000; background: rgba(255,255,255,0.8); padding: 4px 8px; border-radius: 4px; font-size: 8px;">
  © 2025 Roam. All rights reserved. The Roam App™ is a trademark of Roam Curated LLC.
</div>
</body>
</html>
