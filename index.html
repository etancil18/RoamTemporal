<!DOCTYPE html>
<html>
<head>
  <title>Roam MVP Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
  <style>
    * {
      box-sizing: border-box;
    }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: sans-serif;
    }
    #map {
      height: 100vh;
      width: 100vw;
    }
    .controls {
      position: absolute;
      top: 10px;
      left: 10px;
      right: 10px;
      z-index: 1000;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      background: rgba(255,255,255,0.9);
      padding: 8px;
      border-radius: 8px;
    }
    .controls select,
    .controls input,
    .controls button {
      font-size: 14px;
      padding: 5px;
      flex: 1 1 120px;
    }
    @media (min-width: 768px) {
      .controls {
        flex-wrap: nowrap;
        gap: 10px;
        top: 10px;
        left: 50px;
        right: auto;
      }
      .controls select,
      .controls input,
      .controls button {
        flex: unset;
      }
    }
  </style>
</head>
<body>
<div class="controls">
  <input id="map-search" type="text" placeholder="What's the vibe..." />

  <select id="themeDropdown">
    <option value="">Select Theme</option>
    <option value="Quiet Luxury">Quiet Luxury</option>
    <option value="Hedonist's Loop">Hedonist's Loop</option>
    <option value="Creative Recharge">Creative Recharge</option>
    <option value="Wellness Ritual">Wellness Ritual</option>
    <option value="Alt Crawl">Alt Crawl</option>
    <option value="Power Lunch">Power Lunch</option>
    <option value="Cozy Corners">Cozy Corners</option>
    <option value="Flirt & Flow">Flirt & Flow</option>
    <option value="Urban Safari">Urban Safari</option>
  </select>

  <select id="neighborhood-input">
    <option value="">Select Neighborhood</option>
    <option>Alphabet City</option>
    <option>BedStuy</option>
    <option>Bushwick</option>
    <option>Chelsea</option>
    <option>Chinatown</option>
    <option>Clinton Hill</option>
    <option>Downtown Brooklyn</option>
    <option>Dumbo</option>
    <option>East Village</option>
    <option>Gramercy</option>
    <option>Greenpoint</option>
    <option>Greenwich Village</option>
    <option>Lower East Side</option>
    <option>Long Island City</option>
    <option>Midtown</option>
    <option>SoHo</option>
    <option>Tribeca</option>
    <option>Upper East Side</option>
    <option>Upper West Side</option>
    <option>West Village</option>
    <option>Williamsburg</option>
  </select>

  <select id="priceFilter">
    <option value="">Price</option>
    <option value="$">$</option>
    <option value="$$">$$</option>
    <option value="$$$">$$$</option>
    <option value="$$$$">$$$$</option>
  </select>

  <select id="durationDropdown">
    <option value="medium">How Long?</option>
    <option value="short">Short (‚â§2h)</option>
    <option value="medium">Medium (2.5‚Äì5h)</option>
    <option value="long">Long (5.5‚Äì8h)</option>
  </select>

  <button id="crawlNowBtn">Crawl Now</button>
  <button id="favoritesCrawlBtn">Favorites Crawl</button>
  <button id="removeLastPoint">Remove Last Point</button>
  <button id="clearRoute">Clear Route</button>
</div>
<div id="map"></div>
<div id="details"></div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
<script>
   
  
  function getTodayHours(hoursArray) {
    const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
    const today = days[new Date().getDay()];
    const todayEntry = hoursArray.find(entry => entry.startsWith(today));
    return todayEntry || "Hours not available";
  }

  function isOpenNow(hoursArray) {
    const now = new Date();
    const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
    const today = dayNames[now.getDay()];
    const todayHoursEntry = hoursArray.find(h => h.toUpperCase().startsWith(today.toUpperCase()));
    if (!todayHoursEntry) return false;
    const cleanHours = todayHoursEntry.replace(/\u2013|\u2014|\u2212/g, "-").replace(/\u202F|\u00A0/g, " ");
    const match = cleanHours.match(/(\d{1,2}(?::\d{2})?\s*[APMapm]{2})\s*-\s*(\d{1,2}(?::\d{2})?\s*[APMapm]{2})/);
    if (!match) return false;
    const [_, openStr, closeStr] = match;
    const open = new Date(`${now.toDateString()} ${openStr}`);
    let close = new Date(`${now.toDateString()} ${closeStr}`);
    if (close <= open) close.setDate(close.getDate() + 1);
    return now >= open && now <= close;
  }
  
  let map;
  let markerCluster = L.markerClusterGroup();
  let allMarkers = [];
  const themes = {
    "Quiet Luxury": ["luxury", "elegant", "refined"],
    "Hedonist's Loop": ["party", "dance", "cocktail"],
    "Creative Recharge": ["art", "gallery", "creative"],
    "Wellness Ritual": ["spa", "wellness", "juice"],
    "Alt Crawl": ["alt", "underground", "grunge"],
    "Power Lunch": ["business", "lunch", "network"],
    "Cozy Corners": ["cozy", "quiet", "nook"],
    "Flirt & Flow": ["romantic", "date", "vibe"],
    "Urban Safari": ["rooftop", "scenic", "explore"]
  };

  window.addEventListener('DOMContentLoaded', () => {
    map = L.map('map').setView([40.72, -73.98], 12);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap contributors & Carto',
      subdomains: 'abcd',
      maxZoom: 19
    }).addTo(map);

    map.addLayer(markerCluster);

    fetch('events.json')
      .then(res => res.json())
      .then(events => {
        events.forEach(ev => {
          const marker = L.marker([parseFloat(ev.lat), parseFloat(ev.lon)]);
          marker.name = ev.name;
          marker.vibe = ev.vibe || '';
          marker.price = ev.price || '';
          marker.tags = (ev.tags || '').toLowerCase().split(',').map(t => t.trim());

          marker.on('click', () => showDetails(ev, marker.getLatLng()));
          
          allMarkers.push(marker);
          markerCluster.addLayer(marker);
        });
      });

    document.getElementById('map-search').addEventListener('input', applyFilters);
    document.getElementById('themeDropdown').addEventListener('change', applyFilters);
    document.getElementById('priceFilter').addEventListener('change', applyFilters);

    function applyFilters() {
      const query = document.getElementById('map-search').value.toLowerCase();
      const theme = document.getElementById('themeDropdown').value;
      const price = document.getElementById('priceFilter').value.trim();
      markerCluster.clearLayers();

      allMarkers.forEach(marker => {
        const searchMatch = !query || marker.name.toLowerCase().includes(query) || marker.vibe.toLowerCase().includes(query);
        const priceMatch = !price || (marker.price && marker.price.trim() === price);
        const themeTags = themes[theme] || [];
        const themeMatch = !theme || themeTags.some(tag => marker.tags.includes(tag));

        if (searchMatch && priceMatch && themeMatch) {
          markerCluster.addLayer(marker);
        }
      });
    }

    function showOnlySelectedMarkers() {
  markerCluster.clearLayers();
  allMarkers.forEach(marker => {
    if (selectedPoints.some(p => marker.getLatLng().equals(p))) {
      markerCluster.addLayer(marker);
    }
  });
}
    
    function showDetails(ev, latlng) {
  const details = document.getElementById('details');
  const suggestions = findNearbySimilar(latlng, (ev.vibe || '').toLowerCase(), 350);

  let suggestionHtml = suggestions.length > 0
    ? `<strong>Also could be the move:</strong><ul>${suggestions.map(s => `<li>${s.name}</li>`).join('')}</ul>`
    : '<em>No similar spots nearby</em>';

  const todayHours = ev.hours ? getTodayHours(ev.hours) : "No hours available";
  const isOpen = isOpenNow(ev.hours || []);
  const statusText = isOpen ? "üü¢ Open Now" : "üî¥ Closed Now";

  details.innerHTML = `
    <strong>${ev.name}</strong><br>
    Vibe: ${ev.vibe}<br>
    Price: ${ev.price || "N/A"}<br>
    Status: ${statusText}<br>
    Today's Hours: ${todayHours}<br>
    <a href="${ev.link}" target="_blank">View More</a><br>
    <button id="favoriteLocationBtn">‚ù§Ô∏è</button>
    <button id="addToRoute">Add to Route</button>
    <button id="exportGooglePopup">Export Route to Google Maps</button>
    <button id="closeDetails">Close</button>
    <hr>
    ${suggestionHtml}
  `;

  details.style.display = 'block';

  document.getElementById('favoriteLocationBtn').addEventListener('click', () => {
    saveFavorite(ev.name);
  });
  document.getElementById('addToRoute').addEventListener('click', () => {
    addPointToRoute(latlng);
  });
  document.getElementById('exportGooglePopup').addEventListener('click', () => {
    if (selectedPoints.length < 2) {
      alert('Select at least 2 points to export a route.');
      return;
    }
    const base = "https://www.google.com/maps/dir/";
    const path = selectedPoints.map(p => `${p.lat},${p.lng}`).join('/');
    window.open(base + path, '_blank');
  });
  document.getElementById('closeDetails').addEventListener('click', () => {
    details.style.display = 'none';
  });
}
  });

  document.getElementById('crawlNowBtn').addEventListener('click', () => {
  const neighborhood = document.getElementById('neighborhood-input').value.toLowerCase();
  if (!neighborhood) {
    alert('Please select a neighborhood.');
    return;
  }
  const neighborhoodCenters = {
  "alphabet city": L.latLng(40.7265, -73.9815),
  "bedstuy": L.latLng(40.6850, -73.9419),
  "bushwick": L.latLng(40.6943, -73.9213),
  "chelsea": L.latLng(40.7465, -74.0014),
  "chinatown": L.latLng(40.7158, -73.9970),
  "clinton hill": L.latLng(40.6896, -73.9606),
  "downtown brooklyn": L.latLng(40.6928, -73.9903),
  "dumbo": L.latLng(40.7033, -73.9881),
  "east village": L.latLng(40.7260, -73.9816),
  "gramercy": L.latLng(40.7376, -73.9857),
  "greenpoint": L.latLng(40.7301, -73.9546),
  "greenwich village": L.latLng(40.7336, -74.0027),
  "lower east side": L.latLng(40.7150, -73.9843),
  "long island city": L.latLng(40.7440, -73.9488),
  "midtown": L.latLng(40.7549, -73.9840),
  "soho": L.latLng(40.7233, -74.0030),
  "tribeca": L.latLng(40.7163, -74.0086),
  "upper east side": L.latLng(40.7736, -73.9566),
  "upper west side": L.latLng(40.7870, -73.9754),
  "west village": L.latLng(40.7359, -74.0036),
  "williamsburg": L.latLng(40.7081, -73.9571)
};

// Core time mapping
function getCurrentTimeCategory(hour) {
  if (hour >= 6 && hour < 11) return ['morning'];
  if (hour >= 11 && hour < 14) return ['midday'];
  if (hour >= 14 && hour < 16) return ['afternoon'];
  if (hour >= 16 && hour < 19) return ['happyhour'];
  if (hour >= 19 && hour < 22) return ['evening'];
  if (hour >= 22 || hour < 28) return ['late'];
  return [];
}

function parseTimeStringToHour(timeString) {
  const [time, modifier] = timeString.trim().split(/\s+/);
  let [hours, minutes] = time.split(':').map(Number);
  if (modifier.toLowerCase().includes('pm') && hours !== 12) hours += 12;
  if (modifier.toLowerCase().includes('am') && hours === 12) hours = 0;
  return hours;
}

function isOpenNow(hoursToday, hourNow) {
  const openHour = parseTimeStringToHour(hoursToday.split('‚Äì')[0]);
  const closeHour = parseTimeStringToHour(hoursToday.split('‚Äì')[1]);
  return hourNow >= openHour && hourNow < (closeHour === 0 ? 24 : closeHour);
}

function areNearby(v1, v2, maxDistance = 0.5) {
  const R = 6371;
  const dLat = (v2.lat - v1.lat) * Math.PI / 180;
  const dLon = (v2.lon - v1.lon) * Math.PI / 180;
  const a =
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(v1.lat * Math.PI / 180) * Math.cos(v2.lat * Math.PI / 180) *
    Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  const distance = R * c;
  return distance <= maxDistance;
}

function getMaxEnergyRamp(day) {
  const limits = {
    monday: 2,
    tuesday: 2,
    wednesday: 3,
    thursday: 4,
    friday: 5,
    saturday: 5,
    sunday: 3
  };
  return limits[day] || 5;
}

function getBehaviorTags(day) {
  const behaviors = {
    monday: ['coffee', 'chill', 'food', 'hidden gem'],
    tuesday: ['coffee', 'chill', 'hidden gem'],
    wednesday: ['dinner', 'art', 'comedy'],
    thursday: ['cocktail', 'music', 'buzz'],
    friday: ['nightlife', 'party', 'rooftop'],
    saturday: ['adventure', 'brunch', 'experience'],
    sunday: ['wellness', 'calm', 'relax']
  };
  return behaviors[day] || [];
}

const themes = {
  "Quiet Luxury": ["wine", "date night", "hidden gem"],
  "Hedonist's Loop": ["rooftop", "nightlife", "jazz"],
  "Creative Recharge": ["coffee", "artsy", "hidden gem"],
  "Wellness Ritual": ["wellness", "tea", "calm"],
  "Alt Crawl": ["indie", "dive bar", "grunge"],
  "Power Lunch": ["midday", "networking", "bistro"],
  "Cozy Corners": ["books", "tea", "quiet"],
  "Flirt & Flow": ["date night", "wine", "speakeasy"],
  "Urban Safari": ["hidden gem", "adventure", "unexpected"]
};

function getSuggestedTheme(context) {
  const { mood = '', timeCategories = [], weather = '' } = context;
  const moodTags = mood.toLowerCase().split(/\s+/);
  const tags = [...moodTags, ...timeCategories, weather.toLowerCase()];

  const ranked = Object.entries(themes).map(([theme, keywords]) => {
    const matchScore = keywords.filter(k => tags.includes(k)).length;
    return { theme, score: matchScore };
  }).sort((a, b) => b.score - a.score);

  return ranked[0]?.theme || null;
}

function buildPath(startEvent, events, maxStops = 6, maxEnergy) {
  const path = [startEvent];
  let currentEnergy = startEvent.energyRamp;

  while (path.length < maxStops) {
    const next = events.find(e =>
      !path.includes(e) &&
      e.energyRamp >= currentEnergy &&
      e.energyRamp <= maxEnergy &&
      areNearby(path[path.length - 1], e)
    );
    if (!next) break;
    path.push(next);
    currentEnergy = next.energyRamp;
  }
  return path;
}

function buildCrawl(events, now = new Date(), theme = null, context = {}, maxDuration = 8) {
  const hour = now.getHours();
  const day = now.toLocaleString('en-US', { weekday: 'long' }).toLowerCase();
  const timeCategories = getCurrentTimeCategory(hour);
  const maxEnergyRamp = getMaxEnergyRamp(day);
  const themeUsed = theme || getSuggestedTheme({ ...context, timeCategories });
  const themeTags = themeUsed ? themes[themeUsed] || [] : [];
  const behaviorTags = getBehaviorTags(day);

  const candidates = events.filter(e =>
    e[day.slice(0, 3)] !== '-' &&
    e.energyRamp <= maxEnergyRamp &&
    timeCategories.some(cat => e.timeCategory.includes(cat)) &&
    isOpenNow(e.hours.find(h => h.toLowerCase().includes(day)), hour) &&
    (themeTags.length === 0 || themeTags.some(tag => e.tags.includes(tag))) &&
    behaviorTags.some(tag => e.tags.includes(tag))
  );

  let bestPath = [];
  for (let event of candidates) {
    const path = buildPath(event, candidates, 6, maxEnergyRamp);
    const totalDuration = path.reduce((sum, e) => sum + e.duration, 0);
    if (totalDuration <= maxDuration && path.length > bestPath.length) {
      bestPath = path;
    }
  }

  return bestPath.map((e, i) => {
    return {
      name: e.name,
      vibe: e.vibe,
      startTime: `${(hour + i * e.duration).toFixed(2)}h`,
      duration: e.duration,
      energyRamp: e.energyRamp
    }
  });
}

// Trigger crawl generation when button is clicked
const crawlNowBtn = document.getElementById('crawlNowBtn');
if (crawlNowBtn) {
  crawlNowBtn.addEventListener('click', () => {
    const now = new Date();
    const selectedTheme = document.getElementById('themeDropdown')?.value || null;
    const selectedLength = document.getElementById('durationDropdown')?.value || 'medium';
    const durationLimits = {
      short: 2,
      medium: 5,
      long: 8
    };
    const maxDuration = durationLimits[selectedLength];
    const crawl = buildCrawl(events, now, selectedTheme, {}, maxDuration);
    console.log("Generated Crawl:", crawl);
    // TODO: Render the crawl visually or route on map
  });
}
</script>
</body>
</html>
